from collections import defaultdict
from enum import IntEnum

example = \
"""
.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............
"""

puzzle = \
"""
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^...^...................................................................
.............................................................................................................................................
..................................................................^.^...^.^..................................................................
.............................................................................................................................................
.................................................................^.^...^.^.^.................................................................
.............................................................................................................................................
................................................................^.^...^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.......^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^...^.....^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^.^.......^.............................................................
.............................................................................................................................................
............................................................^...^.^.^...^...^...^............................................................
.............................................................................................................................................
...........................................................^.^.^.....^.^.^.^.....^...........................................................
.............................................................................................................................................
..........................................................^.^.....^.^.^.^.^.^.....^..........................................................
.............................................................................................................................................
.........................................................^.^.^.^.^.^...^.....^...^.^.........................................................
.............................................................................................................................................
........................................................^.^.^.^.....^...^.^.^.^.^...^........................................................
.............................................................................................................................................
.......................................................^.^.^...^.^.^.^.^.......^.^.^.^.......................................................
.............................................................................................................................................
......................................................^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^......................................................
.............................................................................................................................................
.....................................................^.^.....^.^.^.^.^...^.^.......^...^.....................................................
.............................................................................................................................................
....................................................^.^...^.^.^...^...^.^.......^...^...^....................................................
.............................................................................................................................................
...................................................^...^...^.....^.^.^...^.^.^.^.^...^.^.^...................................................
.............................................................................................................................................
..................................................^.^.^.^.^.^.....^.^...^.....^...^.....^.^..................................................
.............................................................................................................................................
.................................................^.^.^.^.^...^.....^.^...^.^.....^...^.^...^.................................................
.............................................................................................................................................
................................................^...^.^.^.^.^.^.^...^.....^.^.^.^.^.^.^.^...^................................................
.............................................................................................................................................
...............................................^...^.^...^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...............................................
.............................................................................................................................................
..............................................^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^..............................................
.............................................................................................................................................
.............................................^.^.....^.^...^...^.^.......^.^.^.^.....^...^.^.^.^.............................................
.............................................................................................................................................
............................................^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.....^.^............................................
.............................................................................................................................................
...........................................^.^.^.^.^...^.......^.^...^.......^.^.^.^...^.^.....^.^...........................................
.............................................................................................................................................
..........................................^...^.^.^...^...^.^.^...^.^.^...........^.^.^.^...^.^.^.^..........................................
.............................................................................................................................................
.........................................^...^.^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.^...^.^.^.^...^.^.........................................
.............................................................................................................................................
........................................^...^...^.^.^.^.^.^.......^.^.^.^.^.^.^.^.....^...^...^.^.^.^........................................
.............................................................................................................................................
.......................................^.^...^.^.^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.......................................
.............................................................................................................................................
......................................^.^.....^.......^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.....^.^.....^......................................
.............................................................................................................................................
.....................................^...^.^...^...^.....^.^.^...^.^...^.^...^.^.....^.......^.^.^.^.^.^.....................................
.............................................................................................................................................
....................................^.......^...^.^...^.^.^.^.^...^...^.^.^...^.^...^.^.^.^.....^.^.^...^....................................
.............................................................................................................................................
...................................^.^.^.^...^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^...^.^...^.^...^.....^...................................
.............................................................................................................................................
..................................^.^.^.^.....^.....^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^.^..................................
.............................................................................................................................................
.................................^.^.^.^.....^...^.^.....^...^...^...^.^...^.^.....^.^.^.^.^...^.^.^.......^.................................
.............................................................................................................................................
................................^.^.^.^.^.^.^.^...^.^.^...^...^.^.^...^.^.^...^.^.....^.^.^.......^...^.^.^.^................................
.............................................................................................................................................
...............................^.^.^...^.^.....^.^...^.......^.^...^.^.^...^...^.^.^.^.^...^.^...^.^.^.......^...............................
.............................................................................................................................................
..............................^.^...^.^.^.^.^.......^...^.^.....^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^...^.^.^..............................
.............................................................................................................................................
.............................^...^.^.^.^.^.^...^.....^.....^.^.^.........^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^.............................
.............................................................................................................................................
............................^...^.^.....^.^.^.....^.......^...^...^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^............................
.............................................................................................................................................
...........................^.^.....^...^.^.^.^.^...^...^.....^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.....^...^...^.^.^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^.^.....^.^.....^.^.^...^.^.^.^...^.^.^.^...^..........................
.............................................................................................................................................
.........................^.^...^...^.^.^.....^.^.^...^.^.....^.^.^.^.^.^.^.^.....^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.........................
.............................................................................................................................................
........................^.^.......^.^...^...^.^.^...^.....^.^.^.^.^...^.^.^.^.^.^.^.^...^...^.....^...^.^...........^........................
.............................................................................................................................................
.......................^.^.^.......^.^.^.^...^.^.^.^...^.^.^...^.^.^.^...^.^.^.........^.^.^.^.^...^.^.^.^.^.......^.^.......................
.............................................................................................................................................
......................^.^.^.......^...^.^.^...^...^.^.^.......^.^...^.^.^.^.^.^.^.^...^.....^...^.^.^...^.....^.^.^.^.^......................
.............................................................................................................................................
.....................^.^...^...^.^...^.^.^.......^.......^.^.^.^...^...^...^.^...^.^.^.^.^.^.....^...^.^...^...^.^.....^.....................
.............................................................................................................................................
....................^...^.^.^.^...^...^.^.^...^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^...^...^.^...^...^.^.^.^.^.^.^...^....................
.............................................................................................................................................
...................^.^.^.^.^.^.^.....^.....^.^.^.^...^.^.^.^.^.^.^.^.^...^...^...^...^.^.^.^.^.^...^.^.^.^.....^.^.^.....^...................
.............................................................................................................................................
..................^.^.^.^...^.^.^...^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^.^...^.^.....^.^.^.^...^.^.^...^.....^.^.^.^.^.^.^..................
.............................................................................................................................................
.................^.^...^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.....^.....^.^.....^...^...^.^.^.^.^.^...^.^.^.................
.............................................................................................................................................
................^.^.^...^.^.^.^.^...^.^.^.^...^.....^.^.^.....^.^.^.^.^.^.^...^...^.^.^.^...^.^...^.^.^.^.^.^...^.^.^.^...^.^................
.............................................................................................................................................
...............^.^...^.^.^...^.^.^.^.^...^.^.^...^.^.^.^.....^...^.^.^.....^.........^.^.^...^...^...^.^.....^.^.^.^.^.^.^.^.^...............
.............................................................................................................................................
..............^...^.^.^...^.^.^...^.^.^.^...^...^.^.^...^.^.^.^.....^...^.....^.^.^.^.^.^.......^.^.....^.^.^.....^.^...^...^.^..............
.............................................................................................................................................
.............^.^.^.^.^.^.....^...^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...^...^...^.^.^...^...^...^.^.^.^.^.^.............
.............................................................................................................................................
............^.^.^.....^...^.^.^.^.....^.^...^.^...^.^.^.^.^.^.^...^.......^.^.^.........^.^...^...^.^.^...^.^.^.^.^.^...^...^.^.^............
.............................................................................................................................................
...........^.^.^...^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^...^.^...^.^...^...^...^...^.^.^.^.....^.^.........^.^...^.^.^.^.^.^.^.^.^...........
.............................................................................................................................................
..........^...^.......^.^.......^...........^.^.^.......^.^.^.^.^.^...^.........^.^.^...^.^.^...^.^.^.....^.^.^.^.^.^.^...^.^...^.^..........
.............................................................................................................................................
.........^...^...^.^.^...^.^...^.^.....^.^...^.^.^.^.^.^.^.^...^.^.....^.^.^.....^.^.^.^.........^.^...^.^.^.^.........^.^.....^...^.........
.............................................................................................................................................
........^.^.^.^...^...^...^...^.^.....^.....^.^.^...^...^.^.^.^.^.......^.^...^.^.^.^.^.....^.^.......^...^.^.^.^...^...^...^.^...^.^........
.............................................................................................................................................
.......^.^...^.^...^...^.^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.^...^.....^.^.^.^.......
.............................................................................................................................................
......^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.....^...^...^.^.^.^.^.^...^.^.^.....^.^.^.....^.^.....^.^...^.^.^.^.^...^.....^......
.............................................................................................................................................
.....^.^.^.....^.^.....^.....^.^.^.^...^.^.^.^.^.^...^.^.^...^.^.^.^.^.^...^.^.....^.....^.^...^.....^.^.^.........^.^...^...^...^...^.^.....
.............................................................................................................................................
....^...^.^.^.^.^.^...^...^...^...^...^.^.^.^...^.^.^...^.^.^.^.^...^.^.^.^.^...^...^.^.^...^.....^.^.^.^.^.^...^.^.....^.^.^.^.^...^.^.^....
.............................................................................................................................................
...^.^.^.^...^.^.^.......^.^.^.^.^.^.^...^.^.^.^.....^.^.......^.^.....^.^...^.^.^.^.....^.^.^.^.......^.....^.......^.^...^.^...^.^...^.^...
.............................................................................................................................................
..^...^.^.^.^.^...^...^...^...^.^...^...^.^.........^.^.^...^...^.^.^.^.^.^.^.....^.^.^.^.^.^.....^.^...^.^...^.^...^...^...^...^.^.^...^.^..
.............................................................................................................................................
.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.......^...^.^.^.....^...^...^.......^...^.^.^.^...^.....^.^...^.......^.^.^.^.^...^.
.............................................................................................................................................
"""

class ObstaclesType(IntEnum):
    Start = 0
    Splitter = 1

ObstacleRow = defaultdict[int, ObstaclesType | None]

def parse(data: str) -> list[ObstacleRow]:
    obstacles_rows = []
    for line in data.splitlines():
        if not line:
            continue
        obstacles: ObstacleRow = defaultdict(lambda: None)
        for col, c in enumerate(line):
            if c == "S":
                obstacles[col] = ObstaclesType.Start
            elif c == "^":
                obstacles[col] = ObstaclesType.Splitter
        obstacles_rows.append(obstacles)
    return obstacles_rows


def solve1(obstacles_rows: list[ObstacleRow], debug: bool = False) -> int:
    total = 0
    beams: list[int] = []
    beams_log: list[list[int]] = []
    for obstacle_row in obstacles_rows:
        new_beams: list[int] = []
        through_beams: list[int] = []
        splitted_beams: list[int] = []
        for beam_col in beams:
            if (obstacle := obstacle_row[beam_col]) is not None:
                if obstacle == ObstaclesType.Splitter:
                    splitted_beams.append(beam_col - 1)
                    splitted_beams.append(beam_col + 1)
                    total += 1
            else:
                through_beams.append(beam_col)
        for i, obstacle in obstacle_row.items():
            if obstacle == ObstaclesType.Start:
                new_beams.append(i)
        
        beams = sorted(list(set(new_beams + through_beams + splitted_beams)))
        beams_log.append(beams)

    if debug:
        x = min(beams)
        y = max(beams)
        for obstacle_row, beams in zip(obstacles_rows, beams_log):
            line_chars = []
            for col in range(x, y+1):
                if (obstacle := obstacle_row[col]) is not None:
                    if obstacle == ObstaclesType.Start:
                        line_chars.append("S")
                    else:
                        line_chars.append("^")
                elif col in beams:
                    line_chars.append("|")
                else:
                    line_chars.append(".")
            print("".join([c for c in line_chars]))
    return total


def solve2(obstacles_rows: list[ObstacleRow], debug: bool = False) -> int:
    beams: list[int] = []
    timelines: defaultdict[int, int] = defaultdict(lambda: 0)
    timelines_log: list[defaultdict[int, int]] = []
    for obstacle_row in obstacles_rows:
        new_beams: list[int] = []
        through_beams: list[int] = []
        splitted_beams: list[int] = []

        new_timelines: defaultdict[int, int] = defaultdict(lambda: 0)
        for beam_col in beams:
            if (obstacle := obstacle_row[beam_col]) is not None:
                if obstacle == ObstaclesType.Splitter:
                    splitted_beams.append(beam_col - 1)
                    splitted_beams.append(beam_col + 1)
                    new_timelines[beam_col-1] += timelines[beam_col]
                    new_timelines[beam_col+1] += timelines[beam_col]
            else:
                through_beams.append(beam_col)
                new_timelines[beam_col] += timelines[beam_col]
        for i, obstacle in obstacle_row.items():
            if obstacle == ObstaclesType.Start:
                new_beams.append(i)
                new_timelines[i] = 1
        beams = sorted(list(set(new_beams + through_beams + splitted_beams)))
        timelines = new_timelines
        timelines_log.append(timelines)
        # print(f"{timelines.values()} {sum(timelines.values())=}")

    if debug:
        x = min(beams)
        y = max(beams)
        for obstacle_row, timelines in zip(obstacles_rows, timelines_log):
            line_chars = []
            for col in range(x, y+1):
                if (obstacle := obstacle_row[col]) is not None:
                    if obstacle == ObstaclesType.Start:
                        line_chars.append("SSS")
                    else:
                        line_chars.append("^^^")
                else:
                    left_pad = 3 - len(str(timelines[col]))
                    pad = left_pad * "_"
                    line_chars.append(f"{pad}{timelines[col]}")
            print("".join([str(c) for c in line_chars]))
    return sum(timelines.values())

if __name__ == "__main__":
    print(solve1(parse(example), debug=True))
    print(solve1(parse(puzzle), debug=True))
    print(solve2(parse(example), debug=True))
    print(solve2(parse(puzzle), debug=False))
